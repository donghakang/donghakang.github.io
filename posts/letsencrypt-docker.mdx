---
title: Let's Encrypt + docker + nginx
author: "Dongha Kang"
date: "2022-01-20"
tag: ["SSL", "https", "docker", "nginx"]
---


âš Â ì—¬ê¸°ì„œ ë¶€í„°ëŠ” ì§€ê·¹íˆ ë‚˜ì˜ í”„ë¡œì íŠ¸ êµ¬ì¡°ì´ë‹¤ ë³´ë‹ˆ ë‹¤ë¥¸ êµ¬ì¡°ë¡œ ì§„í–‰ í•˜ëŠ” ë°©ë²•ë„ ë¬´ì¡°ê±´ ìˆì„ ê²ƒì´ë‹¤.

í•˜ì§€ë§Œ ì´ê²ƒì€ ë‚˜ì˜ êµ¬ì¡°ì´ê³  ... ì‘ë™ í•œë‹¤.

## ğŸ‘·ğŸ¼â€â™‚ï¸Â í”„ë¡œì íŠ¸ êµ¬ì¡°

```bash
project
â”œâ”€â”€ docker-local
â”‚Â Â  â”œâ”€â”€ docker-compose.yml    # docker ì‹¤í–‰ íŒŒì¼
â”‚Â Â  â”œâ”€â”€ openresty             # lua-scriptê°€ ìˆëŠ” nginxë¼ê³  ìƒê°í•˜ë©´ëœë‹¤.
â”‚Â Â  â””â”€â”€ postgresql            # db
â”œâ”€â”€ server                    # fastapië¥¼ ì´ìš©í•œ ë°±ì—”ë“œ
â”‚Â Â  â”œâ”€â”€ Dockerfile
â”‚Â Â  â”œâ”€â”€ app
â”‚Â Â  â”œâ”€â”€ requirements.txt
â”‚Â Â  â””â”€â”€ runserver.py
â””â”€â”€ client                    # ì›¹ ì½”ë”©
 Â Â  â”œâ”€â”€ src
 Â Â  â”œâ”€â”€ node_modules
 Â Â  â””â”€â”€ package.json
```

`docker-local` í´ë” ì•ˆì— docker-compose ë¥¼ ì‹¤í–‰ì‹œí‚¤ë©´, server ê°™ì€ ê²½ìš°, `tiangolo/uvicorn-gunicorn:python3.8`ì„ ì´ìš©í•´ì„œ fastapi ë¥¼ ì‹¤í–‰í•˜ëŠ” Dockerfileì„ ì‹¤í–‰ì‹œí‚¤ê³ , postgresql ëŠ” `postgres:13.2` ì´ë¯¸ì§€ë¥¼ ì‹¤í–‰ì‹œí‚¨ë‹¤. (ì§€ê¸ˆ contextì™€ëŠ” ë³„ë¡œ ì•ˆì¤‘ìš”...)

client ê°™ì€ ê²½ìš°ëŠ” buildí•œ í´ë”ë¥¼ ë‚˜ì¤‘ì— dockerë¥¼ ì´ìš©, nginxë¥¼ ì‚¬ìš©í•´ì„œ ê°™ì´ ì‹¤í–‰ì‹œí‚¬ ì˜ˆì •ì´ë©° ë‹¤ë¥¸ docker imageë“¤ë„ nginx.conf (openresty í´ë”ì•ˆì— ìœ„ì¹˜)ì•ˆ proxy_passë¡œ ì—°ê²° í•´ì¤€ë‹¤.

ì—¬ê¸°ì„œ í¬ì¸íŠ¸ëŠ” `nginx.conf` ì•ˆì— ì¸ì¦ì„œë¥¼ ë„£ì„ ê³„íšì´ë‹¤.

## âš™ï¸Â ì…‹ì—…

ì§€ë‚œë²ˆ í¬ìŠ¤íŠ¸ ì²˜ëŸ¼ ì¬ê°±ì‹ ì„ ì§„í–‰í•˜ê²Œ ëœë‹¤ë©´, `/root/.acme.sh/my-domain/` ì•ˆì—ëŠ” ì´ë¯¸ ë‹¤ .cer .key ë“± ì¸ì¦ì„œ íŒŒì¼ë“¤ì´ ì €ì¥ì´ ë˜ì–´ìˆì„ ê²ƒì´ë‹¤.

ê·¸ê²ƒì„ ë‚˜ê°™ì€ ê²½ìš° openresty í´ë” ì•ˆì— ë³µì‚¬ë¥¼ í–ˆë‹¤.

```bash
openresty
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ certs
â”‚   â””â”€â”€ my-domain
â”‚Â Â      â””â”€â”€ all .cer and .key files
â”œâ”€â”€ logs
â””â”€â”€ nginx.conf
```

ì € .cer .key íŒŒì¼ë“¤ì„ dockerì„ ì´ìš©í•˜ì—¬, containerì•ˆìœ¼ë¡œ ëª¨ì‹¤ ê³„íšì´ë‹¤.

ìš°ì„  `docker-compose.yml` ì´ë‹¤.

```yaml
version: "3.7"

services:
  openresty:
  build:
    context: ./openresty
    dockerfile: ./Dockerfile
  image: openresty
  container_name: openresty
  volumes:
    - ./openresty/nginx.conf:/usr/local/openresty/nginx/conf/nginx.conf:ro
    - ./openresty/logs:/var/log/nginx
    - ./openresty/certs:/usr/local/openresty/nginx/certs
    - .../client/dist:/usr/local/openresty/nginx/html/www
    ...
  ...
```

`Dockerfile`

```yaml
FROM openresty/openresty:alpine-fat

RUN mkdir /var/log/nginx

RUN apk add --no-cache openssl-dev
RUN apk add --no-cache git
RUN apk add --no-cache gcc

RUN luarocks install lua-resty-openidc

ENTRYPOINT [ "/usr/local/openresty/nginx/sbin/nginx", "-g", "daemon off;" ]
```

Dockerfile ê°™ì€ ê²½ìš° íŠ¹ë³„ í•œ ê²ƒì€ ì—†ë‹¤. ê·¸ëƒ¥ nginxê°€ ëŒì•„ê°ˆ ê³µê°„ì„ ë§Œë“¤ì–´ì£¼ëŠ” ì •ë„...

docker-compose.yml ì—ëŠ” certsë¥¼ íŠ¹ì • volumeì—ë‹¤ê°€ ë³µì‚¬ë¥¼ í•  ì¤€ë¹„ë¥¼ í•˜ê³  ìˆë‹¤. certs ë¿ë§Œì•„ë‹ˆë¼, client nginx.conf ë„ volumeì•ˆìœ¼ë¡œ ë„£ëŠ”ë‹¤.

**nginx.conf**ê°™ì€ ê²½ìš°, server ì—ì„œ ì¸ì¦ ë°›ì€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì™€ì•¼í•œë‹¤.

```json
server {
    listen 443 ssl http2;
    server_name my-domain;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_certificate     /usr/local/openresty/nginx/certs/my-domain/my-domain.cer;
    ssl_certificate_key /usr/local/openresty/nginx/certs/my-domain/my-domain.key;

    access_log /usr/local/openresty/nginx/logs/my-domain.access.log;
    error_log  /usr/local/openresty/nginx/logs/my-domain.error.log;

```

### ğŸ§˜ğŸ¿â€â™‚ï¸Â  ì§šê³ ê°€ê¸°

nginx.conf ê°€ ì—´ë¦¬ë©´ port 443ì´ ì—´ë¦¬ê³  (80ìœ¼ë¡œ ì„¤ì •í•˜ëŠ”ê²ƒì´ ê°€ì¥ ê¸°ë³¸ì ) ssl, http2 ë¥¼ í™•ì¸í•˜ê³  ssl ì´ ìˆì—ˆê¸° ë•Œë¬¸ì— ssl_certificateì„ í™•ì¸í•œë‹¤. ì € ssl_certificateì˜ ìœ„ì¹˜ëŠ” **docker container (openresty)**ì•ˆì— `/usr/local/openresty/nginx/certs/my-domain` ì•ˆì— ìˆê³  ê·¸ ìœ„ì¹˜ë¡œ ì˜®ê¸°ê²Œ ë„ì™€ì¤€ ê²ƒì€ docker-compose.yml ì— `./openresty/certs:/usr/local/openresty/nginx/certs` ì„ ì½ì–´ì„œ ì´ë‹¤.

ì´ì œ, `docker-compose up â€”build`ë¥¼ ì‹¤í–‰í•˜ê³  ê²°ê³¼ë¥¼ í™•ì¸í•´ë³´ì!
