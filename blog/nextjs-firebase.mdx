---
title: Next.jsì™€ Firebase Analytics
author: "Dongha Kang"
date: "2022-03-18"
tag: ["React"]
---

## ì´ ê¸€ì„ ì½ì—ˆìœ¼ë©´ í•˜ëŠ” ë¶„ë“¤

- ìì‹ ì˜ Next.js í”„ë¡œì íŠ¸ì— Firebase Analyticsì„ ë„£ê³  ì‹¶ì€ ğŸ‘¨ğŸ»â€ğŸ’»
- í˜ì´ì§€ê°€ ë°”ë€” ë•Œë§ˆë‹¤ Firebase analytics realtime ë°˜ì‘ì„ í™•ì¸ í•˜ê³  ì‹¶ì€ ğŸ‘¨ğŸ»â€ğŸ’»
- ìì‹ ì˜ Next.js í”„ë¡œì íŠ¸ë¥¼ vercel ë¿ë§Œ ì•„ë‹ˆë¼ Github Pagesì— ë°°í¬í•˜ê³  ì‹¶ì€ ğŸ‘¨ğŸ»â€ğŸ’»

## ğŸ”¥ Firebase installation

Firebase ì´ˆê¸° ì„¤ì •ì€ ë§ì´ ì°¾ì•„ë³´ë©´ ë‚˜ì˜¤ê¸° ë•Œë¬¸ì— ê¸´ ì„¤ëª…ì„ ìƒëµí•´ë„ ë  ê²ƒ ê°™ë‹¤. (Firebase ì›¹ì‚¬ì´íŠ¸ ë“¤ì–´ê°€ê³ , ì½˜ì†”ì— ìƒˆë¡œìš´ í”„ë¡œì íŠ¸ ë§Œë“¤ê³ , í”„ë¡œì íŠ¸ ì„¸íŒ…ì—ì„œ configurationì—ì„œ config ë°ì´í„°ë§Œ ê°€ì ¸ì˜¤ë©´ ëœë‹¤ ... ì£¼ì €ë¦¬ì£¼ì €ë¦¬ ...)

```javascript
const firebaseConfig = {
  apiKey: "XXXXXXXXXXXXXXXXX",
  authDomain: "XXXXXXXXXXXXXXXXX",
  projectId: "XXXXXXXXXXXXXXXXX",
  storageBucket: "XXXXXXXXXXXXXXXXX",
  messagingSenderId: "XXXXXXXXXXXXXXXXX",
  appId: "XXXXXXXXXXXXXXXXX",
  measurementId: "XXXXXXXXXXXXXXXXX",
};
```

ê·¸ë¦¬ê³  firebaseë¥¼ ë‹¤ìš´ ë°›ì•„ì¤€ë‹¤. (ë¸”ë¡œê·¸ ê¸°ì¤€ v9.6.8)

```bash
yarn add firebase
```

---

## ğŸ”¥ Firebase Context

ê¹ƒí—™ê³¼ ìŠ¤íƒ ì˜¤ë²„í”Œë¡œìš°ë¥¼ ì°¾ì•„ë³´ë©´ì„œ ì œì¼ ì¢‹ì€ ì•„ì´ë””ì–´ë¼ê³  ìƒê° í•œ ê²ƒì„ ë‚´ í”„ë¡œì íŠ¸ì— ë„£ì–´ë´¤ê³  íš¨ê³¼ëŠ” ë›°ì–´ ë‚˜ì„œ ì—¬ê¸°ì— ê³µìœ í•œë‹¤.
ê¸°ì¡´ì—, ê·¸ëƒ¥ analyticsë¥¼ import í•˜ëŠ” ë°©ë²• ë³´ë‹¤ëŠ” ì½”ë“œ ì½ê¸°ê°€ ìˆ˜ì›” í–ˆëŠ”ë°, ê·¸ ë°©ë²•ì€ `useContext`ë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì´ì—ˆë‹¤.

```javascript
import firebase from "firebase/compat/app";
import "firebase/compat/analytics";
```

ì—¬ê¸°ì„œ **compatë¥¼ ë„£ì€ ì´ìœ ëŠ” `v9`** ë¼ì„œ ê·¸ëŸ°ê±°ê³  v8ì„ ì‚¬ìš©í•˜ê³  ì‹¶ë‹¤ë©´ compatë¥¼ ë¹¼ë©´ ê·¸ëŒ€ë¡œ ëœë‹¤.

```javascript
if (firebase.apps.length === 0) {
  const firebaseConfig = {
    apiKey: process.env.NEXT_PUBLIC_API_KEY,
    authDomain: process.env.NEXT_PUBLIC_AUTH_DOMAIN,
    projectId: process.env.NEXT_PUBLIC_PROJECT_ID,
    storageBucket: process.env.NEXT_PUBLIC_STORAGE_BUCKET,
    messagingSenderId: process.env.NEXT_PUBLIC_MESSAGING_SENDER_ID,
    appId: process.env.NEXT_PUBLIC_APP_ID,
    measurementId: process.env.NEXT_PUBLIC_MEASUREMENT_ID,
  };
  firebase.initializeApp(firebaseConfig);
}
```

firebaseê°€ ì´ë¯¸ initialized ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³ , ë§Œì•½ì— initializedê°€ ë˜ì–´ ìˆì§€ ì•Šë‹¤ë©´ firebase Configë¥¼ ê°€ì ¸ì™€ì„œ firebaseë¥¼ initialize í•©ë‹ˆë‹¤.
ì—¬ê¸°ì„œ ê°€ì ¸ì˜¨ `process.env.________` ë“¤ì€ ì „ë¶€ í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— .env íŒŒì¼ì— ìˆëŠ” ê°’ë“¤ì´ë©°, .env íŒŒì¼ì— ì©Œ ìœ„ì—ì„œ ë°›ì•„ì˜¨ firebase configë¥¼ ë„£ìœ¼ë©´ ëœë‹¤.
ì €ë ‡ê²Œ ë°ì´í„°ë¥¼ ë„£ëŠ” ì´ìœ ëŠ” ë‹¹ì—°íˆ ë³´ì•ˆ ë¬¸ì œì´ê³  .env íŒŒì¼ì€ githubì— push í•˜ë©´ ì•ˆë˜ë‹ˆê¹.. ğŸ˜…

```javascript
export const FirebaseContext =
  (createContext < firebase.analytics.Analytics) | (null > null);
```

Firebase Context ë¥¼ ì„¤ì •í•´ì¤ë‹ˆë‹¤. typeì€ firebaseê°€ initializeì— ì‹¤íŒ¨í•˜ë©´ `null`, ì„±ê³µí•˜ë©´ `firebase.analytics.Analytics` ê°€ ë©ë‹ˆë‹¤.

```javascript
const FirebaseTrackingProvider = (props: { children: ReactNode }) => {
  const router = useRouter();
  const [tracking, setTracking] =
    (useState < firebase.analytics.Analytics) | (null > null);

  useEffect(() => {
    setTracking(firebase.analytics());

    const handleRouteChange = (url: string) => {
      if (!tracking) {
        return;
      }
      tracking.logEvent("page_view", {
        page_location: url,
      });
    };

    router.events.on("routeChangeStart", handleRouteChange);

    return () => {
      router.events.off("routeChangeStart", handleRouteChange);
    };
  }, [tracking, router]);

  return (
    <FirebaseContext.Provider value={tracking}>
      {props.children}
    </FirebaseContext.Provider>
  );
};
export const useFirebase = () => useContext(FirebaseContext);

export default FirebaseTrackingProvider;
```

- `useEffect`ì•ˆì— ë³´ì‹œë©´ `firebase.analytics()`ë¥¼ trackingê³¼ routerê°€ ë°”ë€”ë•Œ ë§ˆë‹¤ `useState`ë¥¼ ì´ìš©í•´ ì—…ë°ì´íŠ¸ í•©ë‹ˆë‹¤.
- `routeChangeStart`(router ê°€ ë³€ê²½ ë  ì‹œ ì‘ë™ë˜ëŠ” next.jsì˜ ì´ë²¤íŠ¸)ê°€ ì‹¤í–‰ë˜ë©´ `handleRouteChange`ë¥¼ ë¶€ë¥´ê³ , ê·¸ ë•Œ tracking (`firebase.analytics.Analytics`) ì˜ `logEvent`ë¥¼ ë¶€ë¦…ë‹ˆë‹¤.
- `logEvent`ì—ì„œ ì˜ ì•Œê² ì§€(?)ë§Œ, logEventì˜ ì²« inputì€ Event nameì„ ë‘ë²ˆì§¸ inputì€ Event parameterê°€ ë©ë‹ˆë‹¤.
- ì´ ëª¨ë“  Contextë¥¼ ë¬¶ì–´ì„œ useContextì™€ ê°™ì´ export í•˜ë©´ ë‚˜ì¤‘ì— `_app.ts`ì—ì„œ ì‚¬ìš©í•˜ê¸°ë§Œ í•˜ë©´ ë.

ì•„ë˜ëŠ” ì „ì²´ íŒŒì¼ì…ë‹ˆë‹¤

```javascript
// context/FirebaseContext.tsx

import {
  createContext,
  useState,
  useEffect,
  ReactNode,
  useContext,
} from "react";
import firebase from "firebase/compat/app";
import { useRouter } from "next/router";
import "firebase/compat/analytics";

if (firebase.apps.length === 0) {
  const firebaseConfig = {
    apiKey: process.env.NEXT_PUBLIC_API_KEY,
    authDomain: process.env.NEXT_PUBLIC_AUTH_DOMAIN,
    projectId: process.env.NEXT_PUBLIC_PROJECT_ID,
    storageBucket: process.env.NEXT_PUBLIC_STORAGE_BUCKET,
    messagingSenderId: process.env.NEXT_PUBLIC_MESSAGING_SENDER_ID,
    appId: process.env.NEXT_PUBLIC_APP_ID,
    measurementId: process.env.NEXT_PUBLIC_MEASUREMENT_ID,
  };
  firebase.initializeApp(firebaseConfig);
}

export const FirebaseContext =
  (createContext < firebase.analytics.Analytics) | (null > null);

const FirebaseTrackingProvider = (props: { children: ReactNode }) => {
  const router = useRouter();
  const [tracking, setTracking] =
    (useState < firebase.analytics.Analytics) | (null > null);

  useEffect(() => {
    setTracking(firebase.analytics());

    const handleRouteChange = (url: string) => {
      if (!tracking) {
        return;
      }
      tracking.logEvent("page_view", {
        page_location: url,
      });
    };

    router.events.on("routeChangeStart", handleRouteChange);

    return () => {
      router.events.off("routeChangeStart", handleRouteChange);
    };
  }, [tracking, router]);

  return (
    <FirebaseContext.Provider value={tracking}>
      {props.children}
    </FirebaseContext.Provider>
  );
};

export const useFirebase = () => useContext(FirebaseContext);

export default FirebaseTrackingProvider;
```

```javascript
// app.tsx
import type { AppProps } from "next/app";
import FirebaseContext from "../context/FirebaseContext";

function MyApp({ Component, pageProps }: AppProps) {
  return (
    <FirebaseContext>
      <Component {...pageProps} />
    </FirebaseContext>
  );
}

export default MyApp;
```

ì´ì œ pagesì— ìˆëŠ” ëª¨ë“  íŒŒì¼ë“¤, ì¦‰ í˜ì´ì§€ê°€ ë°”ë€” ë•Œ ë§ˆë‹¤ firebase analyticsì˜ ì´ë²¤íŠ¸ê°€ ìƒì„±ì´ ë˜ëŠ” ê²ƒì€ ë¬¼ë¡ ì´ê³  ë‹¤ë¥¸ êµ¬ì„±ìš”ì†Œ (components) ì—ì„œë„ `useFirebase`ë¥¼ ì‚¬ìš©í•´ì„œ
`firebase.analytics()`ë¥¼ ë¶ˆëŸ¬ ì˜¬ ìˆ˜ ìˆë‹¤. ê·¸ ê²ƒì„ ì´ìš©í•´ì„œ ë‹¤ë¥¸ `logEvent`ë„ ì„¤ì •í•´ ì¤„ ìˆ˜ ìˆë‹¤!

---

## ğŸ•Š ì´ì œ ë°°í¬í•´ì•¼ì§€

ë°°í¬ë¥¼ í• ë•ŒëŠ”, ì•ì„œ ë§í–ˆë“¯ì´ env íŒŒì¼ì„ ì§ì ‘ì ìœ¼ë¡œ ì˜¬ë¦¬ë©´ ì•ˆë˜ê¸° ë•Œë¬¸ì—, Github Secretsë¥¼ ì´ìš©í•´ì„œ ì˜¬ë ¤ì•¼í•œë‹¤.
Github Secretsë¥¼ ì‚¬ìš©í•˜ê¸° ì•ì„œ ì´ë²ˆ ë¸”ë¡œê·¸ì— ê³µë¶€í•˜ëŠ” ê²¸ Github Actionsë¥¼ í•œë²ˆ ì‚¬ìš©í•´ë³´ê¸°ë¡œ í–ˆë‹¤.

```yaml
name: Deploy to Github pages
  ...
  # environment values
  - name: Create env file
    run : |
      touch .env &&
      echo NEXT_PUBLIC_API_KEY=${{ secrets.NEXT_PUBLIC_API_KEY }} >> .env &&
      echo NEXT_PUBLIC_AUTH_DOMAIN=${{ secrets.NEXT_PUBLIC_AUTH_DOMAIN }} >> .env &&
      echo NEXT_PUBLIC_PROJECT_ID=${{ secrets.NEXT_PUBLIC_PROJECT_ID }} >> .env &&
      echo NEXT_PUBLIC_STORAGE_BUCKET=${{ secrets.NEXT_PUBLIC_STORAGE_BUCKET }} >> .env &&
      echo NEXT_PUBLIC_MESSAGING_SENDER_ID=${{ secrets.NEXT_PUBLIC_MESSAGING_SENDER_ID }} >> .env &&
      echo NEXT_PUBLIC_APP_ID=${{ secrets.NEXT_PUBLIC_APP_ID }} >> .env &&
      echo NEXT_PUBLIC_MEASUREMENT_ID=${{ secrets.NEXT_PUBLIC_MEASUREMENT_ID }} >> .env &&
      echo WEBSITE_URL=${{ secrets.WEBSITE_URL }} >> .env &&
      cat .env
```

- .env íŒŒì¼ì„ Github Actionsì—ì„œ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì€, ë§¤ë²ˆ .env íŒŒì¼ì„ ë§Œë“¤ì–´ ì£¼ëŠ” ë°©ë²•ì´ë‹¤.
- `${{secrets._______}}` ëŠ” Github í˜ì´ì§€ì—ì„œ í”„ë¡œì íŠ¸ > Settings > Secrets > Actions ì— New repository secretì— ì¶”ê°€ëœ ë³€ìˆ˜ë“¤ê³¼ ê°™ìœ¼ë¯€ë¡œ, env íŒŒì¼ì— ìˆëŠ”
  ê°’ë“¤ì„ secretì— ì €ì¥í•´ì£¼ì.

ì•„ë˜ëŠ” ì „ì²´ development.ymlíŒŒì¼ì…ë‹ˆë‹¤

```yaml
name: Deploy to Github pages

on:
  push:
    branches: [master]

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [14.x]

    steps:
      # checkout action
      - uses: actions/checkout@v3

      # Node version
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v1
        with:
          node-version: ${{ matrix.node-version }}

      # environment values
      - name: Create env file
        run: |
          touch .env &&
          echo NEXT_PUBLIC_API_KEY=${{ secrets.NEXT_PUBLIC_API_KEY }} >> .env &&
          echo NEXT_PUBLIC_AUTH_DOMAIN=${{ secrets.NEXT_PUBLIC_AUTH_DOMAIN }} >> .env &&
          echo NEXT_PUBLIC_PROJECT_ID=${{ secrets.NEXT_PUBLIC_PROJECT_ID }} >> .env &&
          echo NEXT_PUBLIC_STORAGE_BUCKET=${{ secrets.NEXT_PUBLIC_STORAGE_BUCKET }} >> .env &&
          echo NEXT_PUBLIC_MESSAGING_SENDER_ID=${{ secrets.NEXT_PUBLIC_MESSAGING_SENDER_ID }} >> .env &&
          echo NEXT_PUBLIC_APP_ID=${{ secrets.NEXT_PUBLIC_APP_ID }} >> .env &&
          echo NEXT_PUBLIC_MEASUREMENT_ID=${{ secrets.NEXT_PUBLIC_MEASUREMENT_ID }} >> .env &&
          echo WEBSITE_URL=${{ secrets.WEBSITE_URL }} >> .env &&
          cat .env

      - name: Installing my packages
        run: npm install

      - name: ğŸ”¨ Build my App
        run: npm run build

      - name: ğŸ“¦ Export my App
        run: npm run export

      - run: touch ./out/.nojekyll
      - run: echo www._____.___ > out/CNAME # ë§Œì•½ ë„ë©”ì¸ì„ êµ¬ë§¤í–ˆì—ˆë‹¤ë©´ CNAMEì— URLì„ ë„£ì–´ì£¼ì

      - name: Deploy ğŸš€
        uses: JamesIves/github-pages-deploy-action@v4.2.5
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: gh-pages # The branch the action should deploy to.
          FOLDER: out # The folder the action should deploy.
          clean: true
```

---

## Conclusion

Next.js v12, Firebase v9 ë¥¼ ì´ìš©í•˜ì—¬ Next.jsë¥¼ Github Pagesì— ë°°í¬í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë´¤ìŠµë‹ˆë‹¤.
ë¬¼ë¡ , vercelì„ ì‚¬ìš©í•´ì„œ ë°°í¬í•˜ë©´ Next.jsê°€ ë” í¸í•´ì§€ê² ì§€ë§Œ ë‚˜ì²˜ëŸ¼ ê¹ƒí—™ì— ë•Œë ¤ ë°•ì•„ë²„ë¦¬ê³  ì‹¶ì€ ì‚¬ëŒë“¤ì´ ìˆì„ ê²ƒ ê°™ì•„ì„œ
í•œ ë²ˆ ì•Œì•„ë´¤ì—ˆë‹¤. 

ì´ ë¸”ë¡œê·¸ ì—…ë°ì´íŠ¸ë¥¼ ê³„ê¸°ë¡œ Next.js ì™€ Firebaseë¥¼ ì—°ë™ ì‹œí‚¤ëŠ” ë°©ë²•ë„ ìœ ìµí–ˆì§€ë§Œ, ë­ë‹ˆ ë­ë‹ˆí•´ë„ Github Actionsë¥¼ 
í™œìš©í•˜ì—¬ ë°°í¬í˜¹ì€ build í•  ìˆ˜ ìˆëŠ” ê³¼ì •ì—ì„œ ë§ì€ ê²ƒì„ ë°°ì› ë‹¤ (ë³¸ì¸ì€ ì´í›„ì— sitemapì„ ë°”ë¡œ ì—…ë°ì´íŠ¸í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ë„ ì—¬ê¸°ì— ë„£ì–´ë²„ë ¸ë‹¤ ğŸ˜±)
Next.jsë¥¼ ì´ìš©í•´ì„œ ë”ìš± ë” ë¹ ë¥¸ ë¡œë”©ì‹œê°„ë„ í™•ì¸í–ˆìœ¼ë‹ˆ ì•ìœ¼ë¡œëŠ” React ë¿ë§Œ ì•„ë‹ˆë¼ Next.jsì— ëŒ€í•´ì„œë„ ë§ì´ ê³µë¶€í•´ì•¼ê² ë‹¤!
