---
title: husky 🐶, lint-staged, commitlint
author: 'Dongha Kang'
date: '2022-04-10'
tag: ['husky', 'lint-staged']
---

![Husky..?](/img/husky.png)

git hooks는 흔히 git에 push하기 전 발생하는 실수를 방지하기위해 사용됩니다.
흔히 발견되는 실수로는 ESLint가 제대로 적용이 되었는지, 더 나아가서는 Prettier가 제대로 적용이 되어있는지 확인을 하고 push를 한다면 협업에 도움이 많이 되기 때문에 주로 사용된다.

이 git hooks를 더 편리하게 하기위해 **husky**라는 프로그램이 사용하게 된다.

**lint-staged**는 linter들을 git add 가 된 파일들에 한정 명령어를 실행해주는 라이브러리이다.

만약 ESLint와 Prettier를 제대로 설정했다고 가정하자 (만약 설정하지 않았다면 여기에서 설정 방법을 알아보자)

---

## 🏗 설치

```jsx
npx husky-init && npm i
```

명령어를 실행하면 `.husky` 라는 폴더가 생성된 것을 확인 할 수 있으며 그 안에는 `_`라는 폴더와 `pre-commit`이라는 shell script가 있다.

```jsx
npx mrm@2 lint-staged
```

명령어를 실행하면, `package.json` 와 `.husky` 가 업데이트 되는데, `package.json` 에서는 “lint-staged” 라는 문구가 추가가 된다

---

## 🐶 husky!

다운로드 완료가 된 husky는 추가적인 설정이 필요하다. 그것은 husky를 사용하기 위해선 그 의 맞는 git hook을 추가해야한다는 것이다. 그러기 위해선 .husky 의 또 다른 명령어 `npx husky add` 를 사용 해야하는데 정식 홈페이지에 나와있는 예시는 아래와 같다.

```bash
npx husky add .husky/commit-msg 'npx --no-install commitlint --edit "$1"'
```

> 기존 husky@4 에서는 .huskyrc 라는 파일을 생성해서 명령어들을 수정하거나 업그레이드 시킬수 있었지만 이제는 shell script를 써야한다는 불편함을 느끼는 사람들도 꽤 있어서 husky@4를 선호 하시는 개발자들도 많은 것 같다. 나는 최신식을 사용할 계획이다! 다시 본론으로 들어가서 ..

저 명령어가 하는 말은 `.husky` 라는 폴더에 `commit-msg` 라는 script 안에 `npx ...` 명령어를 실행시킨다는 것이다. 즉 commit 메시지를 완성한 후에 `npx commitlint`를 실행시킨다.

husky는 사용되는 shell script 이름들이 정해져있다.

- **pre-commit**: commit을 실행하기 전에 실행
- **prepare-commit-msg**: commit 메시지를 생서하고 편집기 실행 전에 실행
- **commit-msg**: commit 메시지를 완성한 후에 실행
- **post-commit**: commit 완료 후 실행

- **applypatch-msg**: git am을 실행하기 전에 실행
- **pre-applypatch**: patch 적용 할 때 실행. patch 중단 가능
- **post-applypatch**: git am 명령 마지막에 실행. patch 중단 불가능

- **pre-rebase**: rebase 하기 전에 실행
- **post-rewrite**: git commit -amend, git rebase 처럼 커밋 변경 한 후 실행
- **post-merge**: merge 후 실행
- **pre-push**: push 할때 실행. 전송하기 전에 실행하기 때문에 중단 가능

입맛에 맞춰서 `npx husky add .husky/<script command> ‘<run script>’` 를 실행 시키면 된다.

---

## 🖇 Lint-staged

앞서 말했듯, lint-staged 를 사용하면 package.json 과 .husky 폴더안이 변경이 되는데

```json
// package.json
{
	...
	"lint-staged": {
    "*.js": "eslint --cache --fix"
  }
}
```

package.json안에 저 문구가 하는말은 `*.js` 에 해당되는 파일들을 `eslint --cache --fix` 를 이용해 eslint를 확인 하게 된다.

.husky 폴더 안에는 `pre-commit` 라는 새로운 파일이 생겨난 것을 (수정 것을) 확인 할 수 있다. 그 안을 확인하면

```bash
#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

yarn lint-staged
```

“commit 을 할 때, `yarn lint-staged` 가 실행 될거야” 라는 것을 쉽게 예측할 수 있다.

**즉, lint-staged 를 `npx mrm@2` 를 이용해서 다운로드만 한다면, 앞으로 커밋을 할 때, 모든 .js 파일에 한에서 eslint가 제대로 적용이 되었는지 확인 할 수 있는 것이다.**

실제로, eslint를 어기고 커밋하면 에러가 발생한다.

그렇다면, prettier도 적용해보자.

```json
// package.json
{
	...
	"lint-staged": {
    "src/**/*.{ts,tsx,js,jsx,json}": "eslint --cache --fix",
    "src/**/*.{js,jsx,ts,tsx,json,css,scss,md}": "prettier --write"
  }
}
```

참 쉽죠 ?

살짝 또 추가한 부분은, 이제는 모든 .js 파일이 아닌 src/ 안에 존재하는 ts, tsx, js, jsx, json 에 한에서 eslint를 실행하고. 또 그 후에는 css, scss, md 를 포함한 src 안에 있는 파일들에 prettier를 적용한다.

---

## 📝 commitlint

git 에서 커밋을 할 때, 팀원과의 소통을 위해서, 편리한 과거 기록 추적을 위해서 commit 메시지에 대해서 신경을 많이 쓴다.

그것 또한 husky 가 관리를 해줄 수 있는데. 이것을 도와주는 것이 바로 commitlint 와 gitmoji 이다.

```bash
npm install --save-dev @commitlint/config-conventional @commitlint/cli
```

commitlint를 다운로드 한다.

```bash
echo "module.exports = {extends: ['@commitlint/config-conventional']}" > commitlint.config.js
```

eslint와 상당히 비슷한 포맷으로 commitlint도 진행이 되는데, 이와 마찬가지로 기존에 있던 husky 에 commitlint를 이용해 commit message를 확인해주도록하자

```bash
npx husky add .husky/commit-msg 'npx --no -- commitlint --edit $1'
```

이 이후에 git commit 을 실행하고 message가 commitlint 와 비슷하지 않다면 바로 에러가 발생한다. 아래는 예시

```bash
git commit -m "foo: foo"
→ No staged files match any configured task.
⧗   input: foo: foo
✖   Please add rules to your `commitlint.config.js`
    - Getting started guide: https://git.io/fhHij
    - Example config: https://git.io/fhHip [empty-rules]

✖   found 1 problems, 0 warnings
ⓘ   Get help: https://github.com/conventional-changelog/commitlint/#what-is-commitlint

husky - commit-msg hook exited with code 1 (error)
```

---

## ☺️ gitmoji

commit 은 솔직히 이뻐야 제맛. 이제 Emoji 도 넣어주자.

우선 gitmoji에 관련된 commitlint를 넣어주자

```bash
npm i -D commitlint-config-gitmoji commitlint
```

gitmoji를 commitlint 안에 넣어준다.

```bash
echo "module.exports = {extends: ['gitmoji']};" > .commitlintrc.js
```

gitmoji 리스트는 [이곳](https://gitmoji.dev/)에서 확인하자

이거는 나의 rule.

```bash
:sparkles: feat: <새로운 feature가 추가될 때>
:truck: chore: <옮기거나 파일이름을 바꾸어서 실제적인 코드와는 상관이 없을때>
:construction_worker: ci: <CI 에 관련된 빌드를 할때>
:memo: docs: <도큐멘트>
:recycle: refactor: <리팩토링>
:test_tube: test: <테스트 코드>
:lipstick: style: <스타일>
:rewind: revert: <깃을 예전 단계로 돌려놓는다>
:zap: perf: <속도적인 측면에서 업그레이드 될때>
:bug: fix: <오류를 바꾼다>
```

---

## 🧹 정리!

1. ESLint 와 Prettier를 설정한다.
2. lint-staged 를 설정하자 (husky가 자동으로 설정된다!)
3. commitlint와 commitlint-config-gitmoji를 같이 설정한다 !
