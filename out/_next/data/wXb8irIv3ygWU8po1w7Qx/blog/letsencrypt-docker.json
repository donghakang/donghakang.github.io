{"pageProps":{"frontMatter":{"title":"Let's Encrypt + Docker ğŸ³ + NginX","author":"Dongha Kang","date":"2022-01-20","tag":["SSL","https","docker","nginx"]},"slug":"letsencrypt-docker","mdxSource":{"compiledSource":"/*@jsxRuntime automatic @jsxImportSource react*/\nconst {Fragment: _Fragment, jsx: _jsx, jsxs: _jsxs} = arguments[0];\nconst {useMDXComponents: _provideComponents} = arguments[0];\nfunction MDXContent(props = {}) {\n  const {wrapper: MDXLayout} = Object.assign({}, _provideComponents(), props.components);\n  return MDXLayout ? _jsx(MDXLayout, Object.assign({}, props, {\n    children: _jsx(_createMdxContent, {})\n  })) : _createMdxContent();\n  function _createMdxContent() {\n    const _components = Object.assign({\n      p: \"p\",\n      h2: \"h2\",\n      pre: \"pre\",\n      code: \"code\",\n      strong: \"strong\",\n      h3: \"h3\"\n    }, _provideComponents(), props.components);\n    return _jsxs(_Fragment, {\n      children: [_jsx(_components.p, {\n        children: \"âš Â ì—¬ê¸°ì„œ ë¶€í„°ëŠ” ì§€ê·¹íˆ ë‚˜ì˜ í”„ë¡œì íŠ¸ êµ¬ì¡°ì´ë‹¤ ë³´ë‹ˆ ë‹¤ë¥¸ êµ¬ì¡°ë¡œ ì§„í–‰ í•˜ëŠ” ë°©ë²•ë„ ë¬´ì¡°ê±´ ìˆì„ ê²ƒì´ë‹¤.\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"í•˜ì§€ë§Œ ì´ê²ƒì€ ë‚˜ì˜ êµ¬ì¡°ì´ê³  ... ì‘ë™ í•œë‹¤.\"\n      }), \"\\n\", _jsx(_components.h2, {\n        children: \"ğŸ‘·ğŸ¼â€â™‚ï¸Â í”„ë¡œì íŠ¸ êµ¬ì¡°\"\n      }), \"\\n\", _jsx(_components.pre, {\n        children: _jsx(_components.code, {\n          className: \"language-bash\",\n          children: \"project\\nâ”œâ”€â”€ docker-local\\nâ”‚Â Â  â”œâ”€â”€ docker-compose.yml    # docker ì‹¤í–‰ íŒŒì¼\\nâ”‚Â Â  â”œâ”€â”€ openresty             # lua-scriptê°€ ìˆëŠ” nginxë¼ê³  ìƒê°í•˜ë©´ëœë‹¤.\\nâ”‚Â Â  â””â”€â”€ postgresql            # db\\nâ”œâ”€â”€ server                    # fastapië¥¼ ì´ìš©í•œ ë°±ì—”ë“œ\\nâ”‚Â Â  â”œâ”€â”€ Dockerfile\\nâ”‚Â Â  â”œâ”€â”€ app\\nâ”‚Â Â  â”œâ”€â”€ requirements.txt\\nâ”‚Â Â  â””â”€â”€ runserver.py\\nâ””â”€â”€ client                    # ì›¹ ì½”ë”©\\n Â Â  â”œâ”€â”€ src\\n Â Â  â”œâ”€â”€ node_modules\\n Â Â  â””â”€â”€ package.json\\n\"\n        })\n      }), \"\\n\", _jsxs(_components.p, {\n        children: [_jsx(_components.code, {\n          children: \"docker-local\"\n        }), \" í´ë” ì•ˆì— docker-compose ë¥¼ ì‹¤í–‰ì‹œí‚¤ë©´, server ê°™ì€ ê²½ìš°, \", _jsx(_components.code, {\n          children: \"tiangolo/uvicorn-gunicorn:python3.8\"\n        }), \"ì„ ì´ìš©í•´ì„œ fastapi ë¥¼ ì‹¤í–‰í•˜ëŠ” Dockerfileì„ ì‹¤í–‰ì‹œí‚¤ê³ , postgresql ëŠ” \", _jsx(_components.code, {\n          children: \"postgres:13.2\"\n        }), \" ì´ë¯¸ì§€ë¥¼ ì‹¤í–‰ì‹œí‚¨ë‹¤. (ì§€ê¸ˆ contextì™€ëŠ” ë³„ë¡œ ì•ˆì¤‘ìš”...)\"]\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"client ê°™ì€ ê²½ìš°ëŠ” buildí•œ í´ë”ë¥¼ ë‚˜ì¤‘ì— dockerë¥¼ ì´ìš©, nginxë¥¼ ì‚¬ìš©í•´ì„œ ê°™ì´ ì‹¤í–‰ì‹œí‚¬ ì˜ˆì •ì´ë©° ë‹¤ë¥¸ docker imageë“¤ë„ nginx.conf (openresty í´ë”ì•ˆì— ìœ„ì¹˜)ì•ˆ proxy_passë¡œ ì—°ê²° í•´ì¤€ë‹¤.\"\n      }), \"\\n\", _jsxs(_components.p, {\n        children: [\"ì—¬ê¸°ì„œ í¬ì¸íŠ¸ëŠ” \", _jsx(_components.code, {\n          children: \"nginx.conf\"\n        }), \" ì•ˆì— ì¸ì¦ì„œë¥¼ ë„£ì„ ê³„íšì´ë‹¤.\"]\n      }), \"\\n\", _jsx(_components.h2, {\n        children: \"âš™ï¸Â ì…‹ì—…\"\n      }), \"\\n\", _jsxs(_components.p, {\n        children: [\"ì§€ë‚œë²ˆ í¬ìŠ¤íŠ¸ ì²˜ëŸ¼ ì¬ê°±ì‹ ì„ ì§„í–‰í•˜ê²Œ ëœë‹¤ë©´, \", _jsx(_components.code, {\n          children: \"/root/.acme.sh/my-domain/\"\n        }), \" ì•ˆì—ëŠ” ì´ë¯¸ ë‹¤ .cer .key ë“± ì¸ì¦ì„œ íŒŒì¼ë“¤ì´ ì €ì¥ì´ ë˜ì–´ìˆì„ ê²ƒì´ë‹¤.\"]\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"ê·¸ê²ƒì„ ë‚˜ê°™ì€ ê²½ìš° openresty í´ë” ì•ˆì— ë³µì‚¬ë¥¼ í–ˆë‹¤.\"\n      }), \"\\n\", _jsx(_components.pre, {\n        children: _jsx(_components.code, {\n          className: \"language-bash\",\n          children: \"openresty\\nâ”œâ”€â”€ Dockerfile\\nâ”œâ”€â”€ certs\\nâ”‚   â””â”€â”€ my-domain\\nâ”‚Â Â      â””â”€â”€ all .cer and .key files\\nâ”œâ”€â”€ logs\\nâ””â”€â”€ nginx.conf\\n\"\n        })\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"ì € .cer .key íŒŒì¼ë“¤ì„ dockerì„ ì´ìš©í•˜ì—¬, containerì•ˆìœ¼ë¡œ ëª¨ì‹¤ ê³„íšì´ë‹¤.\"\n      }), \"\\n\", _jsxs(_components.p, {\n        children: [\"ìš°ì„  \", _jsx(_components.code, {\n          children: \"docker-compose.yml\"\n        }), \" ì´ë‹¤.\"]\n      }), \"\\n\", _jsx(_components.pre, {\n        children: _jsx(_components.code, {\n          className: \"language-yaml\",\n          children: \"version: \\\"3.7\\\"\\n\\nservices:\\n  openresty:\\n  build:\\n    context: ./openresty\\n    dockerfile: ./Dockerfile\\n  image: openresty\\n  container_name: openresty\\n  volumes:\\n    - ./openresty/nginx.conf:/usr/local/openresty/nginx/conf/nginx.conf:ro\\n    - ./openresty/logs:/var/log/nginx\\n    - ./openresty/certs:/usr/local/openresty/nginx/certs\\n    - .../client/dist:/usr/local/openresty/nginx/html/www\\n    ...\\n  ...\\n\"\n        })\n      }), \"\\n\", _jsx(_components.p, {\n        children: _jsx(_components.code, {\n          children: \"Dockerfile\"\n        })\n      }), \"\\n\", _jsx(_components.pre, {\n        children: _jsx(_components.code, {\n          className: \"language-yaml\",\n          children: \"FROM openresty/openresty:alpine-fat\\n\\nRUN mkdir /var/log/nginx\\n\\nRUN apk add --no-cache openssl-dev\\nRUN apk add --no-cache git\\nRUN apk add --no-cache gcc\\n\\nRUN luarocks install lua-resty-openidc\\n\\nENTRYPOINT [ \\\"/usr/local/openresty/nginx/sbin/nginx\\\", \\\"-g\\\", \\\"daemon off;\\\" ]\\n\"\n        })\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"Dockerfile ê°™ì€ ê²½ìš° íŠ¹ë³„ í•œ ê²ƒì€ ì—†ë‹¤. ê·¸ëƒ¥ nginxê°€ ëŒì•„ê°ˆ ê³µê°„ì„ ë§Œë“¤ì–´ì£¼ëŠ” ì •ë„...\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"docker-compose.yml ì—ëŠ” certsë¥¼ íŠ¹ì • volumeì—ë‹¤ê°€ ë³µì‚¬ë¥¼ í•  ì¤€ë¹„ë¥¼ í•˜ê³  ìˆë‹¤. certs ë¿ë§Œì•„ë‹ˆë¼, client nginx.conf ë„ volumeì•ˆìœ¼ë¡œ ë„£ëŠ”ë‹¤.\"\n      }), \"\\n\", _jsxs(_components.p, {\n        children: [_jsx(_components.strong, {\n          children: \"nginx.conf\"\n        }), \"ê°™ì€ ê²½ìš°, server ì—ì„œ ì¸ì¦ ë°›ì€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì™€ì•¼í•œë‹¤.\"]\n      }), \"\\n\", _jsx(_components.pre, {\n        children: _jsx(_components.code, {\n          className: \"language-json\",\n          children: \"server {\\n    listen 443 ssl http2;\\n    server_name my-domain;\\n\\n    ssl_protocols TLSv1.2 TLSv1.3;\\n    ssl_certificate     /usr/local/openresty/nginx/certs/my-domain/my-domain.cer;\\n    ssl_certificate_key /usr/local/openresty/nginx/certs/my-domain/my-domain.key;\\n\\n    access_log /usr/local/openresty/nginx/logs/my-domain.access.log;\\n    error_log  /usr/local/openresty/nginx/logs/my-domain.error.log;\\n\\n\"\n        })\n      }), \"\\n\", _jsx(_components.h3, {\n        children: \"ğŸ§˜ğŸ¿â€â™‚ï¸Â  ì§šê³ ê°€ê¸°\"\n      }), \"\\n\", _jsxs(_components.p, {\n        children: [\"nginx.conf ê°€ ì—´ë¦¬ë©´ port 443ì´ ì—´ë¦¬ê³  (80ìœ¼ë¡œ ì„¤ì •í•˜ëŠ”ê²ƒì´ ê°€ì¥ ê¸°ë³¸ì ) ssl, http2 ë¥¼ í™•ì¸í•˜ê³  ssl ì´ ìˆì—ˆê¸° ë•Œë¬¸ì— ssl_certificateì„ í™•ì¸í•œë‹¤. ì € ssl_certificateì˜ ìœ„ì¹˜ëŠ” **docker container (openresty)**ì•ˆì— \", _jsx(_components.code, {\n          children: \"/usr/local/openresty/nginx/certs/my-domain\"\n        }), \" ì•ˆì— ìˆê³  ê·¸ ìœ„ì¹˜ë¡œ ì˜®ê¸°ê²Œ ë„ì™€ì¤€ ê²ƒì€ docker-compose.yml ì— \", _jsx(_components.code, {\n          children: \"./openresty/certs:/usr/local/openresty/nginx/certs\"\n        }), \" ì„ ì½ì–´ì„œ ì´ë‹¤.\"]\n      }), \"\\n\", _jsxs(_components.p, {\n        children: [\"ì´ì œ, \", _jsx(_components.code, {\n          children: \"docker-compose up â€”build\"\n        }), \"ë¥¼ ì‹¤í–‰í•˜ê³  ê²°ê³¼ë¥¼ í™•ì¸í•´ë³´ì!\"]\n      })]\n    });\n  }\n}\nreturn {\n  default: MDXContent\n};\n","frontmatter":{},"scope":{}}},"__N_SSG":true}